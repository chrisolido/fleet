---
# Install Postgres 10  
- name: Check if PostgreSQL Repository is installed.
  stat:
    path: /etc/yum.repos.d/pgdg-10-centos.repo
  register: pgdg-10-centos
  tags: setup
    
- name: Install PostgreSQL Repository
  command: rpm -Uvh https://download.postgresql.org/pub/repos/yum/10/redhat/rhel-7-x86_64/pgdg-centos10-10-2.noarch.rpm
  become: yes
  when: not pgdg-10-centos.stat.exists
  tags: setup

- name: Look for fast Cache
  raw: yum makecache fast
  become: true
  tags: setup  

- name: Install PostgreSQL 10 Server
  yum:
    name: "{{ packages }}"
  vars:
    packages:
    - postgresql10-server
    - postgresql10
    - postgresql10-contrib
  become: true
  tags: setup 

- name: Check if PostgreSQL database is initialized.
  stat:
    path: /var/lib/pgsql/10/data/PG_VERSION
  register: pgdata_dir_version

- name: Ensure PostgreSQL database is initialized.
  command: /usr/pgsql-10/bin/postgresql-10-setup initdb
  when: not pgdata_dir_version.stat.exists
  become: yes
  become_user: postgres
  tags: setup

#- name: Check DB if initialized
#  shell: /usr/pgsql-10/bin/postgresql-10-setup initdb
#  register: result

#- name: Initiallized DB
#  command: /usr/pgsql-10/bin/postgresql-10-setup initdb
#  become: true
#  tags: setup
#  changed_when: "result.rc != 2"
  
- name: Enable postgresql10
  systemd:
    name: postgresql-10
    daemon_reload: yes
    state: started
    enabled: yes
  become: true
  tags: setup